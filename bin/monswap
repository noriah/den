#!/usr/bin/env zsh

INPUT_ADDR=0x60

# DDC/CI codes for inputs sources
INPUT_DISPLAYPORT1=15
INPUT_DISPLAYPORT2=16
INPUT_HDMI=17
INPUT_HDMI2=18

# serial numbers of monitors
MONITOR_CENTER=D2FPF43
MONITOR_LEFT=3XGX623
MONITOR_RIGHT=7SGX623

SLEEP_MULTIPLIER=0.01

detectDisplays() {
  eval $(ddcutil detect --sleep-multiplier $SLEEP_MULTIPLIER --dsa | awk -v RS= -F'\n' '
    BEGIN { print "typeset -g -A displays=(" }
    match($2, / +I2C bus:  \/dev\/i2c-([0-9]+)/, b) \
      match($8, / +Serial number: +(\w+)/, s) \
      { print "  [" s[1] "]=" b[1] }
    END { print ")" }')
}

swapinput() {
  local _dsp=$displays[$1]
  local _inp=$2

  ddcutil --sleep-multiplier $SLEEP_MULTIPLIER --dsa \
    --bus $_dsp setvcp $INPUT_ADDR $_inp
}

detectDisplays

case "$1" in
  leftdp)
    swapinput $MONITOR_LEFT $INPUT_DISPLAYPORT1
    ;;
  lefthdmi)
    swapinput $MONITOR_LEFT $INPUT_HDMI
    ;;
  dp)
    swapinput $MONITOR_CENTER $INPUT_DISPLAYPORT1
    swapinput $MONITOR_LEFT $INPUT_DISPLAYPORT1
    ;;
  hdmi)
    swapinput $MONITOR_CENTER $INPUT_HDMI2
    swapinput $MONITOR_LEFT $INPUT_HDMI
    ;;
esac
